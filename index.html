<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #fff; }
        #win { width: 100%; height: 100%; display: flex; flex-direction: column; }
        #head { background: #E84F2F; padding: 16px 20px; color: white; font-weight: bold; font-size: 16px; display: flex; align-items: center; gap: 12px; }
        #msgs { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; background: #fafafa; }
        .msg { padding: 14px 18px; border-radius: 20px; font-size: 14px; max-width: 85%; white-space: pre-wrap; line-height: 1.6; }
        .user { background: #E84F2F; color: white; align-self: flex-end; border-bottom-right-radius: 6px; }
        .ai { background: #fff; color: #333; align-self: flex-start; border-bottom-left-radius: 6px; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .card { background: white; border: 1px solid #eee; border-radius: 14px; padding: 14px; margin-top: 10px; width: 200px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.06); transition: all 0.2s ease; }
        .card:hover { border-color: #E84F2F; transform: translateY(-2px); }
        .card-title { display: block; color: #E84F2F; font-size: 14px; font-weight: bold; }
        .card-sub { font-size: 11px; color: #999; margin-top: 4px; display: block; }
        #input-area { padding: 16px 20px; border-top: 1px solid #eee; display: flex; gap: 12px; background: white; }
        input#in { flex: 1; border: 1px solid #eee; padding: 14px 18px; border-radius: 14px; outline: none; font-size: 16px; background: #f5f5f5; -webkit-appearance: none; }
        input#in:focus { border-color: #E84F2F; background: #fff; }
        button#btn { background: #E84F2F; color: white; border: none; padding: 14px 24px; border-radius: 14px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .dots { display: flex; gap: 6px; padding: 14px 18px; align-self: flex-start; background: #fff; border-radius: 20px; border: 1px solid #eee; }
        .dot { width: 10px; height: 10px; background: #E84F2F; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0.4); opacity: 0.4; } 40% { transform: scale(1.0); opacity: 1; } }
        @media (max-width: 600px) { #head { padding: 20px; font-size: 17px; } #msgs { padding: 16px; } #input-area { padding: 14px 16px; } }
    </style>
</head>
<body>
    <div id="win">
        <div id="head">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="white" viewBox="0 0 256 256"><path d="M214.86,180.12a8,8,0,0,1-11,2.74L136,142.13V216a8,8,0,0,1-16,0V142.13L52.12,182.86a8,8,0,1,1-8.23-13.72L112.45,128,43.89,86.86a8,8,0,1,1,8.23-13.72L120,113.87V40a8,8,0,0,1,16,0v73.87l67.88-40.73a8,8,0,1,1,8.23,13.72L143.55,128l68.56,41.14A8,8,0,0,1,214.86,180.12Z"></path></svg>
            <span>Glowry AI Assistant</span>
        </div>
        <div id="msgs"><div class="msg ai">สวัสดีค่ะ ยินดีต้อนรับสู่ Glowry นะคะ ✨ มีอะไรให้ช่วยแนะนำเมนูสุขภาพไหมคะ?</div></div>
        <div id="input-area">
            <input id="in" placeholder="ถามเราได้เลยค่ะ..." autocomplete="off">
            <button id="btn">ส่ง</button>
        </div>
    </div>

    <script>
        const msgs = document.getElementById('msgs');
        const input = document.getElementById('in');
        const btn = document.getElementById('btn');
        const PROXY = "https://glowry.x10-aistudio.workers.dev/api";

        const MENU_SLUGS = {
            "กรีน บาลานซ์ โบวล์": "green-balance-bowl",
            "ทรอปิคอล พาราไดซ์ โบวล์": "tropical-paradise-bowl",
            "อาซาอิ เอนเนอร์จี โบวล์": "acai-energy-bowl",
            "คาเคา พาวเวอร์": "cacao-power",
            "เบอร์รี บลิส": "berry-bliss",
            "ทรอปิคอล ซันไรส์": "tropical-sunrise",
            "เบอร์รี คาล์ม": "berry-calm",
            "เรด พาวเวอร์": "red-power",
            "ซิตรัส โกลว์": "citrus-glow",
            "กรีน ไวทัลลิตี้": "green-vitality",
            "สไปซี่ เวคอัพ": "spicy-wakeup",
            "แครอท เรเดียนซ์": "carrot-radiance",
            "กรีน รีเซ็ต": "green-reset",
            "โกลเด้น โกลว์": "golden-glow",
            "จินเจอร์ คิก": "ginger-kick"
        };

        async function ask() {
            const text = input.value.trim();
            if (!text) return;
            appendMsg(text, 'user');
            input.value = '';
            const loader = showDots();
            try {
                const res = await fetch(PROXY, { method: 'POST', body: JSON.stringify({ text }), headers: { 'Content-Type': 'application/json' } });
                const data = await res.json();
                loader.remove();
                let rawText = data.text;
                let menuTitles = [];
                const cardMatch = rawText.match(/RELATED_CARDS:\s*\[(.*?)\]/);
                if (cardMatch) {
                    menuTitles = cardMatch[1].split(',').map(t => t.trim().replace(/"/g, ''));
                    rawText = rawText.replace(/RELATED_CARDS:[\s\S]*/, '').trim();
                }
                appendMsg(rawText, 'ai', menuTitles);
            } catch (e) {
                loader.remove();
                appendMsg("ขออภัยค่ะ ระบบขัดข้องค่ะ", 'ai');
            }
        }

        function appendMsg(text, role, menuTitles = []) {
            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'display:flex;flex-direction:column;align-items:' + (role === 'user' ? 'flex-end' : 'flex-start');
            const bubble = document.createElement('div');
            bubble.className = 'msg ' + role;
            bubble.innerText = text;
            wrapper.appendChild(bubble);

            menuTitles.forEach(title => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = '<span class="card-title">' + title + '</span><span class="card-sub">กดเพื่อดูเมนูนี้</span>';
                const slug = MENU_SLUGS[title] || title.toLowerCase().replace(/\s+/g, '-');
                card.onclick = () => window.top.location.href = '/menu/' + slug;
                wrapper.appendChild(card);
            });

            msgs.appendChild(wrapper);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function showDots() {
            const d = document.createElement('div');
            d.className = 'dots';
            d.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
            msgs.appendChild(d);
            msgs.scrollTop = msgs.scrollHeight;
            return d;
        }

        btn.onclick = ask;
        input.onkeydown = (e) => { e.stopPropagation(); if (e.key === 'Enter') ask(); };
        document.body.addEventListener('click', () => input.focus(), true);
    </script>
</body>
</html>
